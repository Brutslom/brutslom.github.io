---
layout: post
title: METODOLOGÍA DE PENTESTING HACÍA UN ACTIVE DIRECTORY. DESPLIEGUE (PARTE 3) (ES)
categories:
- español
tags:
- metodología
- pentesting
- Active Directory
img_path: "/assets/img/posts/20221230/"
date: 2022-12-30 00:00 +0000
---
Hola a todos,

Tras establecer las herramientas que vamos a utilizar, debemos desplegarlas y configurarlas de manera correcta para poder presentar la metodología de ataque que se llevará a cabo.


# Hipervisor 

El hipervisor a utilizar es muy sencillo de instalar, [**VMWare Workstation en la versión 17.0.0 build-20800274**](https://www.vmware.com/go/getworkstation-win). Se ejecuta el instalador y al final del proceso se solicita un serial. 

![Vmware Serial](vmware-serial.png){: width="972" height="589" }
_Vmware Serial_

Si no se introduce ningún serial se podrá utilizar de prueba durante 30 días.

Una vez instalado se puede ejecutar el programa y se visualizará algo como esto:

![Vmware](vmware-final.png){: width="972" height="589" }
_Vmware_

# Entorno vulnerable

Como se ha comentado en el post anterior, es posible realizar el despliegue de [**Detection Lab**](https://www.detectionlab.network/) mediante las [**instrucciones de despliegue**](https://www.detectionlab.network/deployment/).

En nuestro caso no ha sido posible realizar el despliegue de DetectionLab y se ha realizado un despliegue y configuración manual de las diferentes máquinas:

## Windows Server 2016

Con la [**imagen ISO**](https://go.microsoft.com/fwlink/p/?LinkID=2195174&clcid=0x409&culture=en-us&country=US) descargada procederemos a realizar la creación de una máquina con las siguientes características:

- 2 GB de RAM.

- 2 procesadores, con un núcleo por procesador.

- 60 GB de disco duro.

- Adaptador de red NAT, con rango 192.168.140.X.

La configuración del AD realizada ha sido la siguiente:

- Cambio de nombre del equipo a “DC-AD”.
- Configuración de los roles, características del AD y activación de los servicios de dominio del AD.

![AD roles](ad-1.png){: width="972" height="589" }
_AD roles_

- Promoción del servidor a controlador de dominio, que se establece como “jcaballer.local” y dominio “jcaballer” a nivel de NETBIOS, que contiene la base de datos del AD.

![AD resumen](ad-2.png){: width="972" height="589" }
_AD resumen_

Tras el reinicio del AD se debe iniciar sesión a nivel de dominio “@jcaballer.local”.

Para comprender el despliegue de cada uno de los ataques se desactiva el Windows Defender a nivel de dominio con el comando en PowerShell:

```bash
Uninstall-WindowsFeature -Name Windows-Defender
```

Se crean los nuevos usuarios junto con las contraseñas indicadas para cada uno de los equipos:
- AD:
    + Usuario: Administrador
    + Contraseña: Y7w573dbGj
    + Usuario: jcaballeradm (administrador)
    + Contraseña: Password1.
- PC-jcaballero1:
    + Usuario: jcaballero1
    + Contraseña: Passjc1.
- PC-jcaballero2:
    + Usuario: jcaballero1
    + Contraseña: Passjc2.
- PC-jcaballero3:
    + Usuario: jcaballero1
    + Contraseña: Passjc3.

## Windows 10 Enterprise

Con la [**imagen ISO**](https://go.microsoft.com/fwlink/p/?LinkID=2195404&clcid=0x809&culture=en-gb&country=GB) descargada procederemos a realizar la creación de tres máquinas con las siguientes características:

- 2 GB de RAM.
- 2 procesadores, con un núcleo por procesador.
- 60 GB de disco duro.
- Adaptador de red NAT, con rango 192.168.140.X.

Para la configuración de los clientes se ha seguido estos pasos:
- Se cambian los nombres para identificarlos en la red.
    + “PC-jcaballeroX”, cambiando la "X" por un identificador numérico.

- Se realizan cambios en la configuración de las DNS, por la ip del AD, para que puedan identificar el dominio del AD y se comprueba la conexión con el Controlador de dominio:

![Cliente IP](client-1.png){: width="972" height="589" }
_Cliente IP_

- Se conectan al Controlador de dominio con su usuario y contraseña, se reinicia el equipo y se ingresa con la cuenta del AD.
- Al igual que en el AD se desactiva el Windows Defender y su firewall.
- Se añade al usuario jcaballero1 como administrador de los otros dos equipos, como si fuera un técnico que puede acceder con permisos privilegiados a estos equipos para realizar configuración o instalaciones especiales.
    + PC-jcaballero2
    + PC-jcaballero3
- Se añade al usuario jcaballero1 al grupo de Usuarios de Administración Remota.
- Se añade el privilegio “SeBackupPrivilege” y “SeRestorePrivilege” al usuario jcaballero1.
- Se establece un usuario, "jcaballeradm", sin autorización previa en Kerberos.

![Cliente jcaballeradm](client-2.png){: width="972" height="589" }
_Cliente jcaballeradm_

# Sistema Operativo Pentesting

Para la instalación del SO de Parrot, se siguen los siguientes pasos:

- Se descarga de la [**imagen ISO**](https://bunny.deb.parrot.sh//parrot/iso/5.1.2/Parrot-security-5.1.2_amd64.iso) especifica de seguridad.

- Se crea una nueva máquina virtual en el hipervisor, con un nombre identificativo, con estas características:
    + 4 GB de Ram
    + 2 procesadores, con un núcleo por procesador.
    + 40 GB de disco duro.
    + Adaptador de red NAT, para que utilice la misma red que los equipos del entorno AD.

- Una vez iniciada la máquina por la ISO descargada se debe ejecutar el archivo que se encuentra en el escritorio “Install Parrot” y se establecen las características requeridas:

    + Idioma: Español de España
    + Localización: Madrid
    + Distribución de teclado: por defecto.
    + Borrado de disco completo.
    + Usuario: jcaballero
    + Contraseña: jcaballero

![Resumen instalación Parrot](parrot-1.png){: width="972" height="589" }
_Resumen instalación Parrot_

- Reinicio y ejecución de la máquina de pentesting.

![Parrot-sec os](parrot-2.png){: width="972" height="589" }
_Parrot-sec os_

___

Finalmente el estado final de la red sería el siguiente:

![Entorno Final](entorno-final.png){: width="972" height="589" }
_Entorno Final_

___

# Conclusión

Esto sería todo, en el siguiente post entraremos en materia en relación a la metodología que deberá seguir el auditor a la hora de realizar una auditoria a un Directorio Activo.
